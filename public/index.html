<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
    <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î IoT ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® DIY</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Noto Sans Thai Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- ECharts for charts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <!-- Firebase v9 (Modular) for Authentication (Optional) -->
    <script type="module" crossorigin>
        // --- Authentication (Firebase, optional) ---
        // 1) Create a Firebase project: https://console.firebase.google.com/
        // 2) Enable Email/Password and/or Google provider in Authentication.
        // 3) Replace the placeholder config below with your project's config.
        // 4) If you do not want Firebase, you can remove this block and
        //    use the simple "Demo Mode" credentials logic further below.

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            appId: "YOUR_FIREBASE_APP_ID"
        };

        // If the user has not provided config, run in demo mode gracefully.
        let useFirebase = true;
        for (const k of ['apiKey', 'authDomain', 'projectId', 'appId']) {
            if (!firebaseConfig[k] || firebaseConfig[k].startsWith('YOUR_FIREBASE')) { useFirebase = false; break; }
        }

        let auth = null;
        if (useFirebase) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            window.__auth = auth; // expose for other scripts

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    updateAuthDisplay(true, `${user.email || user.displayName}`);
                    document.body.classList.remove('demo-mode');
                    closeAuthPopup();
                } else {
                    updateAuthDisplay(false);
                    document.body.classList.add('demo-mode');
                }
            });

            document.getElementById('btn-login').addEventListener('click', async () => {
                const email = /** @type {HTMLInputElement} */(document.getElementById('email')).value;
                const password = /** @type {HTMLInputElement} */(document.getElementById('password')).value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (e) {
                    alert('Login failed: ' + e.message);
                }
            });

            document.getElementById('btn-google').addEventListener('click', async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (e) {
                    alert('Google sign-in failed: ' + e.message);
                }
            });

            document.getElementById('btn-logout').addEventListener('click', async () => {
                try { await signOut(auth); } catch (e) { alert('Logout failed: ' + e.message); }
            });
        } else {
            // --- Demo Mode Auth (do NOT use in production) ---
            window.__auth = null;
            updateAuthDisplay(false);
            document.getElementById('auth-status').textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏•‡∏≠‡∏á: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ';
            document.body.classList.add('demo-mode');

            document.getElementById('btn-login').addEventListener('click', () => {
                updateAuthDisplay(true, 'demo@example.com');
                closeAuthPopup();
            });
            document.getElementById('btn-google').addEventListener('click', () => {
                updateAuthDisplay(true, '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏î‡∏•‡∏≠‡∏á (Google)');
                closeAuthPopup();
            });
            document.getElementById('btn-logout').addEventListener('click', () => {
                updateAuthDisplay(false);
            });
        }
    </script>
    <style>
        :root {
            --bg: #0b1220;
            --panel: #121a2b;
            --muted: #a6b0c3;
            --text: #e8eefc;
            --accent: #4ca3ff;
        }

        [data-theme="light"] {
            --bg: #f8fafc;
            --panel: #ffffff;
            --muted: #64748b;
            --text: #1e293b;
            --accent: #3b82f6;
        }

        * {
            font-family: "Noto Sans Thai", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: "Noto Sans Thai", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }

        /* Ensure Bootstrap components use Thai font */
        .navbar-brand,
        .navbar-nav .nav-link,
        .btn,
        .form-control,
        .form-label,
        .card,
        .dropdown-item,
        .modal,
        .tooltip,
        .popover,
        /* Chart and dynamic content */
        canvas,
        svg,
        .echarts-tooltip,
        .maplibre-popup,
        .maplibre-ctrl,
        /* Status and interactive elements */
        .stat,
        .value,
        .label,
        .auth-popup,
        .footer,
        /* All headings and text elements */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        p,
        span,
        div,
        a,
        button,
        input,
        select,
        textarea,
        label,
        legend {
            font-family: "Noto Sans Thai", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif !important;
        }

        .hidden {
            display: none !important;
        }

        /* Custom Bootstrap Navbar Styling with Enhanced Transparency */
        .navbar {
            background: rgba(11, 18, 32, 0.75) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(30, 42, 68, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .navbar {
            background: rgba(248, 250, 252, 0.75) !important;
            border-bottom: 1px solid rgba(226, 232, 240, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        .navbar-brand {
            color: var(--text) !important;
            font-weight: 600;
            font-size: 18px;
        }

        .navbar-nav .nav-link {
            color: var(--text) !important;
            background: rgba(18, 26, 43, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(30, 42, 68, 0.3);
            border-radius: 10px;
            padding: 8px 12px !important;
            margin: 0 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="light"] .navbar-nav .nav-link {
            background: rgba(255, 255, 255, 0.6);
            border-color: rgba(226, 232, 240, 0.3);
        }

        .navbar-nav .nav-link:hover {
            background: rgba(18, 26, 43, 0.8);
            border-color: var(--accent) !important;
            color: var(--text) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(76, 163, 255, 0.2);
        }

        [data-theme="light"] .navbar-nav .nav-link:hover {
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);
        }

        .navbar-toggler {
            border: 1px solid var(--text);
            padding: 4px 8px;
        }

        .navbar-toggler:focus {
            box-shadow: none;
        }

        .navbar-toggler-icon {
            background-image: none;
            width: 20px;
            height: 15px;
            position: relative;
        }

        .navbar-toggler-icon::before,
        .navbar-toggler-icon::after,
        .navbar-toggler-icon {
            background: var(--text);
        }

        .navbar-toggler-icon,
        .navbar-toggler-icon::before,
        .navbar-toggler-icon::after {
            width: 20px;
            height: 2px;
            background: var(--text);
            border-radius: 1px;
            transition: all 0.3s;
        }

        .navbar-toggler-icon::before,
        .navbar-toggler-icon::after {
            content: '';
            position: absolute;
            left: 0;
        }

        .navbar-toggler-icon::before {
            top: -6px;
        }

        .navbar-toggler-icon::after {
            bottom: -6px;
        }

        /* Enhanced navbar collapse animation */
        .navbar-collapse {
            transition: all 0.3s ease-in-out;
        }

        @media (max-width: 991.98px) {
            .navbar-collapse {
                background: rgba(11, 18, 32, 0.95);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(30, 42, 68, 0.3);
                border-radius: 12px;
                padding: 12px;
                margin-top: 8px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            }

            [data-theme="light"] .navbar-collapse {
                background: rgba(255, 255, 255, 0.95);
                border-color: rgba(226, 232, 240, 0.3);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            }

            .navbar-nav {
                gap: 8px;
            }

            .navbar-nav .nav-link {
                width: 100%;
                justify-content: flex-start;
                margin: 0;
            }

            .d-flex.align-items-center.gap-2 {
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid rgba(30, 42, 68, 0.2);
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 8px !important;
            }

            [data-theme="light"] .d-flex.align-items-center.gap-2 {
                border-top-color: rgba(226, 232, 240, 0.3);
            }
        }

        .theme-toggle,
        .auth-button {
            background: var(--panel);
            color: var(--text);
            border: 1px solid;
            border-color: #1e2a44;
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 13px;
            cursor: pointer;
            transition: border-color 0.2s;
            margin: 0 2px;
        }

        [data-theme="light"] .theme-toggle,
        [data-theme="light"] .auth-button {
            border-color: #e2e8f0;
        }

        .theme-toggle:hover,
        .auth-button:hover {
            border-color: var(--accent);
        }

        .auth-status-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--muted);
        }

        .badge {
            background: #0f233d;
            color: var(--muted);
            border: 1px solid;
            border-color: #1e2a44;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        [data-theme="light"] .badge {
            background: #f1f5f9;
            border-color: #e2e8f0;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 14px;
            padding: 14px;
            height: calc(100vh - 80px);
            box-sizing: border-box;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Enhanced Responsive Grid Layout */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                padding: 12px;
            }

            #chart {
                height: 48vh;
            }
        }

        @media (max-width: 992px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 12px;
                height: auto;
                min-height: calc(100vh - 80px);
            }

            .map-wrap {
                grid-row: 1;
                grid-column: 1;
                height: 50vh;
                min-height: 300px;
            }

            #chart {
                height: 45vh;
                min-height: 250px;
            }
        }

        .card {
            background: var(--panel);
            border: 1px solid;
            border-color: #1e2a44;
            border-radius: 14px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        [data-theme="light"] .card {
            border-color: #e2e8f0;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }

        #map {
            height: 100%;
            width: 100%;
            border-radius: 14px;
            touch-action: manipulation;
            /* Better mobile touch */
        }

        @media (max-width: 768px) {
            #map {
                border-radius: 10px;
            }
        }

        @media (max-width: 480px) {
            #map {
                border-radius: 8px;
            }
        }

        .map-wrap {
            grid-row: 1 / span 2;
            grid-column: 1;
            overflow: hidden;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 12px;
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 10px;
            }

            .stat {
                padding: 12px;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .stat .label {
                font-size: 13px;
            }

            .stat .value {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .stats {
                padding: 8px;
                gap: 6px;
            }

            .stat {
                padding: 10px;
            }

            .stat .label {
                font-size: 12px;
            }

            .stat .value {
                font-size: 16px;
            }
        }

        .stat {
            padding: 14px;
            border-radius: 12px;
            background: #0f1630;
            border: 1px solid #203054;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        [data-theme="light"] .stat {
            background: #f1f5f9;
            border-color: #e2e8f0;
        }

        .stat .label {
            color: var(--muted);
            font-size: 12px;
        }

        .stat .value {
            font-weight: 700;
            font-size: 22px;
        }

        #chart {
            height: 52vh;
            border-radius: 14px;
        }

        .panel {
            padding: 12px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .controls>* {
                width: 100%;
                min-height: 44px;
                /* Better touch targets */
            }

            .controls label {
                font-weight: 500;
                margin-bottom: 4px;
                display: block;
            }
        }

        @media (max-width: 480px) {
            .controls {
                gap: 6px;
            }

            .controls select,
            .controls input,
            .controls button {
                padding: 12px 16px;
                font-size: 14px;
                border-radius: 12px;
            }
        }

        .controls select,
        .controls input,
        .controls button {
            background: #0f233d;
            color: var(--text);
            border: 1px solid;
            border-color: #1e2a44;
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 13px;
        }

        [data-theme="light"] .controls select,
        [data-theme="light"] .controls input,
        [data-theme="light"] .controls button {
            background: var(--panel);
            border-color: #e2e8f0;
        }

        .controls button:hover {
            border-color: var(--accent);
        }

        .auth {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth input {
            width: 170px;
        }

        .footer {
            background: var(--panel);
            border-top: 1px solid;
            border-top-color: #1e2a44;
            margin-top: 40px;
            padding: 30px 20px 15px;
            color: var(--muted);
            font-size: 13px;
        }

        [data-theme="light"] .footer {
            border-top-color: #e2e8f0;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 15px;
        }

        [data-theme="light"] .footer-bottom {
            border-top-color: #e2e8f0;
        }

        .footer-bottom p {
            margin: 4px 0;
            font-size: 11px;
            opacity: 0.8;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .footer-bottom {
                padding-top: 12px;
            }

            .footer-bottom p {
                font-size: 10px;
                margin: 3px 0;
            }
        }

        @media (max-width: 480px) {
            .footer-bottom p {
                font-size: 9px;
                margin: 2px 0;
                padding: 0 5px;
            }
        }

        /* Enhanced Responsive Styles */
        @media (max-width: 1200px) {
            .main-container {
                padding: 12px;
            }

            .card {
                border-radius: 12px;
            }
        }

        @media (max-width: 992px) {
            body {
                overflow-x: hidden;
            }

            .navbar-brand {
                font-size: 16px;
            }

            .auth-status-display {
                flex-direction: column;
                gap: 4px;
            }

            .auth-status-display span {
                font-size: 11px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
                gap: 10px;
            }

            .navbar {
                padding: 8px 12px;
            }

            .navbar-brand {
                font-size: 15px;
            }

            .card {
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .panel {
                padding: 10px;
            }

            .auth-popup {
                padding: 15px;
            }

            .auth-popup-content {
                max-width: 90vw;
                margin: 0 auto;
            }

            .footer {
                padding: 20px 15px;
                margin-top: 20px;
            }

            .footer-bottom p {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: 8px;
                gap: 8px;
                height: auto;
            }

            .navbar {
                padding: 6px 10px;
            }

            .navbar-brand {
                font-size: 14px;
            }

            .map-wrap {
                height: 40vh;
                min-height: 250px;
            }

            #chart {
                height: 35vh;
                min-height: 200px;
            }

            .card {
                border-radius: 8px;
            }

            .panel {
                padding: 8px;
            }

            .theme-toggle,
            .auth-button {
                padding: 8px;
                min-width: 40px;
                min-height: 40px;
            }

            .navbar-nav .nav-link {
                padding: 10px 14px !important;
                font-size: 14px;
                margin: 2px 0;
            }

            .auth-popup {
                padding: 10px;
            }

            .auth-popup-content {
                border-radius: 12px;
                max-width: 95vw;
            }

            .auth-popup-input {
                padding: 14px 16px;
                font-size: 16px;
                /* Prevent zoom on iOS */
            }

            .auth-popup-button {
                padding: 14px 16px;
                font-size: 15px;
            }
        }

        /* Tablet and Landscape Orientations */
        @media (min-width: 769px) and (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1.1fr 0.9fr;
                gap: 12px;
            }

            .navbar {
                padding: 10px 18px;
            }

            .navbar-brand {
                font-size: 16px;
            }

            .navbar-nav .nav-link {
                padding: 7px 10px !important;
                font-size: 12px;
            }
        }

        /* Landscape Phone Optimization */
        @media (max-height: 500px) and (orientation: landscape) {
            .main-container {
                grid-template-columns: 1.5fr 1fr;
                height: calc(100vh - 60px);
            }

            .navbar {
                padding: 4px 12px;
            }

            .map-wrap {
                height: calc(100vh - 80px);
            }

            #chart {
                height: calc(100vh - 120px);
            }

            .stats {
                grid-template-columns: repeat(3, 1fr);
                padding: 8px;
            }

            .stat {
                padding: 8px;
                flex-direction: column;
            }

            .stat .label {
                font-size: 11px;
            }

            .stat .value {
                font-size: 16px;
            }
        }

        /* Large Screen Optimization */
        @media (min-width: 1400px) {
            .main-container {
                max-width: 1400px;
                margin: 0 auto;
                grid-template-columns: 1.3fr 1fr;
            }

            .card {
                border-radius: 16px;
            }

            #chart {
                height: 55vh;
            }
        }

        .theme-toggle {
            background: var(--panel);
            color: var(--text);
            border: 1px solid #1e2a44;
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color 0.2s;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
        }

        .theme-icon {
            display: block;
        }

        [data-theme="light"] .theme-toggle {
            border-color: #e2e8f0;
        }

        [data-theme="light"] .dark-icon {
            display: none;
        }

        [data-theme="light"] .light-icon {
            display: block;
        }

        [data-theme="dark"] .light-icon,
        .light-icon {
            display: none;
        }

        .auth-button {
            background: var(--panel);
            color: var(--text);
            border: 1px solid;
            border-color: #1e2a44;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: border-color 0.2s;
        }

        [data-theme="light"] .auth-button {
            border-color: #e2e8f0;
        }

        .auth-button:hover {
            border-color: var(--accent);
        }

        .auth-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 20px;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .auth-popup {
                align-items: flex-start;
                padding: 20px 15px;
                padding-top: 10vh;
            }
        }

        @media (max-width: 480px) {
            .auth-popup {
                padding: 15px 10px;
                padding-top: 5vh;
            }
        }

        .auth-popup-content {
            background: var(--panel);
            border: 1px solid;
            border-color: #1e2a44;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            max-width: 400px;
            width: calc(100% - 40px);
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        @media (max-width: 768px) {
            .auth-popup-content {
                max-width: 100%;
                width: calc(100% - 30px);
                padding: 20px;
                border-radius: 12px;
                max-height: 85vh;
            }
        }

        @media (max-width: 480px) {
            .auth-popup-content {
                width: calc(100% - 20px);
                padding: 16px;
                border-radius: 10px;
                max-height: 90vh;
            }
        }

        [data-theme="light"] .auth-popup-content {
            border-color: #e2e8f0;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .auth-popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .auth-popup-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            color: var(--text);
        }

        .auth-popup-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--muted);
            padding: 4px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .auth-popup-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        [data-theme="light"] .auth-popup-close:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .auth-popup-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-popup-input {
            background: var(--bg);
            color: var(--text);
            border: 1px solid;
            border-color: #1e2a44;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        [data-theme="light"] .auth-popup-input {
            border-color: #e2e8f0;
        }

        .auth-popup-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .auth-popup-buttons {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .auth-popup-button {
            flex: 1;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .auth-popup-button:hover {
            opacity: 0.9;
        }

        .auth-popup-button.secondary {
            background: var(--panel);
            color: var(--text);
            border: 1px solid;
            border-color: #1e2a44;
        }

        [data-theme="light"] .auth-popup-button.secondary {
            border-color: #e2e8f0;
        }

        .auth-status-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--muted);
        }

        .nav-link {
            background: var(--panel);
            color: var(--text);
            border: 1px solid;
            border-color: #1e2a44;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 13px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: border-color 0.2s;
        }

        [data-theme="light"] .nav-link {
            border-color: #e2e8f0;
        }

        .nav-link:hover {
            border-color: var(--accent);
        }

        @media (max-width: 1000px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }

            .map-wrap {
                grid-row: auto;
                grid-column: auto;
                height: 48vh;
            }

            #map {
                height: 100%;
            }

            #chart {
                height: 42vh;
            }
        }
    </style>
</head>

<body>
    <!-- Bootstrap Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="./">ÔøΩ ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î IoT ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® DIY</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto me-3">
                    <li class="nav-item">
                        <a class="nav-link" href="register.html">
                            <span>üì±</span>
                            <span>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">
                            <span>‚ÑπÔ∏è</span>
                            <span>‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö</span>
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center gap-2">
                    <button id="theme-toggle" class="theme-toggle" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°">
                        <span class="theme-icon dark-icon">üåô</span>
                        <span class="theme-icon light-icon hidden">‚òÄÔ∏è</span>
                    </button>
                    <div class="auth-status-display">
                        <span id="auth-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‚Ä¶</span>
                        <button id="auth-button" class="auth-button" title="‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô">
                            <span id="auth-icon">üîí</span>
                            <span id="auth-text">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                        </button>
                        <button id="btn-logout" class="auth-button hidden">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Authentication Popup -->
    <div id="auth-popup" class="auth-popup hidden">
        <div class="auth-popup-content">
            <div class="auth-popup-header">
                <h3 class="auth-popup-title">‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h3>
                <button id="auth-popup-close" class="auth-popup-close" title="‡∏õ‡∏¥‡∏î">√ó</button>
            </div>
            <div class="auth-popup-form">
                <input id="email" class="auth-popup-input" type="email" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•" />
                <input id="password" class="auth-popup-input" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
                <div class="auth-popup-buttons">
                    <button id="btn-login" class="auth-popup-button">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button id="btn-google" class="auth-popup-button secondary">Google</button>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="map-wrap card">
            <div id="map"></div>
        </div>

        <div class="card">
            <div class="stats">
                <div class="stat">
                    <span class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</span>
                    <span id="device-count" class="value">0</span>
                </div>
                <div class="stat">
                    <span class="label">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                    <span id="selected-device" class="value">‚Äî</span>
                </div>
                <div class="stat">
                    <span class="label">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                    <span id="last-update" class="value">‚Äî</span>
                </div>
            </div>
            <div class="panel">
                <div class="controls">
                    <label for="device-select">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</label>
                    <select id="device-select"></select>
                    <label for="time-range">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</label>
                    <select id="time-range">
                        <option value="6h">6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</option>
                        <option value="12h">12 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</option>
                        <option value="24h" selected>24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</option>
                        <option value="7d">7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</option>
                    </select>
                    <button id="btn-refresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div id="chart"></div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-bottom">
            <p>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ¬© OpenStreetMap ‚Ä¢ ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏î‡πâ‡∏ß‡∏¢ MapLibre GL JS ‡πÅ‡∏•‡∏∞ ECharts</p>
            <p>&copy; 2025 CMU GIST North - DIY Air Quality IoT System ‚Ä¢ ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏à‡∏±‡∏¢</p>
        </div>
    </footer>

    <script>
        // ------------------------------
        // Configuration (replace endpoints)
        // ------------------------------
        const API = {
            devices: '/api/devices', // should return an array of {id,name,lat,lon,pm25,pm10,updated_at}
            timeseries: (deviceId, range) => `/api/timeseries?device_id=${encodeURIComponent(deviceId)}&range=${encodeURIComponent(range)}` // returns [{timestamp, pm25, pm10}]
        };

        // For demo purposes, we provide mock data when API endpoints are unavailable.
        const DEMO_DEVICES = [
            { id: 'DUST-001', name: '‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ‡∏°‡∏ä.', lat: 18.805, lon: 98.955, pm25: 32, pm10: 47, updated_at: new Date().toISOString() },
            { id: 'DUST-002', name: '‡∏ñ‡∏ô‡∏ô‡∏ô‡∏¥‡∏°‡∏°‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏¥‡∏ô‡∏ó‡πå', lat: 18.796, lon: 98.967, pm25: 41, pm10: 57, updated_at: new Date().toISOString() },
            { id: 'DUST-003', name: '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÅ‡∏°‡πà‡∏£‡∏¥‡∏°', lat: 18.936, lon: 98.942, pm25: 24, pm10: 36, updated_at: new Date().toISOString() }
        ];

        function mockTimeseries(deviceId, hours = 24) {
            const now = Date.now();
            const step = 5 * 60 * 1000; // 5 minutes
            const pts = [];
            for (let t = now - hours * 3600 * 1000; t <= now; t += step) {
                const base25 = 20 + 10 * Math.sin(t / 3.6e6) + Math.random() * 8;
                const base10 = base25 + 12 + Math.random() * 10;
                pts.push({ timestamp: new Date(t).toISOString(), pm25: +(base25.toFixed(1)), pm10: +(base10.toFixed(1)) });
            }
            return pts;
        }

        // ------------------------------
        // Map Initialization (MapLibre)
        // ------------------------------
        const map = new maplibregl.Map({
            container: 'map',
            // Minimal raster style using free OSM tiles
            style: {
                version: 8,
                sources: {
                    osm: {
                        type: 'raster',
                        tiles: [
                            'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
                            'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
                            'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
                        ],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors'
                    }
                },
                layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
            },
            center: [98.967, 18.796],
            zoom: 11
        });

        map.addControl(new maplibregl.NavigationControl({ showCompass: true }), 'top-right');
        map.addControl(new maplibregl.ScaleControl({ maxWidth: 120, unit: 'metric' }));

        // Device layer (GeoJSON source)
        const devicesSourceId = 'devices-src';
        const devicesLayerId = 'devices-layer';

        map.on('load', () => {
            map.addSource(devicesSourceId, { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
            map.addLayer({
                id: devicesLayerId,
                type: 'circle',
                source: devicesSourceId,
                paint: {
                    'circle-radius': 7,
                    'circle-color': [
                        'interpolate', ['linear'], ['get', 'pm25'],
                        0, '#7ad151', 25, '#fde725', 50, '#f2831e', 100, '#d7191c'
                    ],
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#0b1220'
                }
            });

            map.on('click', devicesLayerId, (e) => {
                const f = e.features?.[0];
                if (!f) return;
                const id = f.properties.id;
                const name = f.properties.name;
                document.getElementById('selected-device').textContent = name;
                const sel = document.getElementById('device-select');
                sel.value = id;
                refreshChart();
                new maplibregl.Popup().setLngLat(e.lngLat)
                    .setHTML(`<strong>${name}</strong><br/>PM2.5: ${f.properties.pm25}<br/>PM10: ${f.properties.pm10}`)
                    .addTo(map);
            });

            initializeApp();
        });

        // ------------------------------
        // Chart (ECharts)
        // ------------------------------
        let chart;

        function getChartThemeColors() {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            return {
                textColor: isDark ? '#cfd7e6' : '#64748b',
                axisLineColor: isDark ? '#4a5f88' : '#cbd5e1',
                axisLabelColor: isDark ? '#a6b0c3' : '#64748b',
                splitLineColor: isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)',
                pm25Color: isDark ? '#4ca3ff' : '#3b82f6',
                pm10Color: isDark ? '#ff6b6b' : '#ef4444'
            };
        }

        function createBaseChartOption() {
            const colors = getChartThemeColors();
            const thaiFont = '"Noto Sans Thai", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif';
            return {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    textStyle: { fontFamily: thaiFont }
                },
                grid: { left: 55, right: 20, top: 20, bottom: 45 },
                legend: {
                    textStyle: {
                        color: colors.textColor,
                        fontFamily: thaiFont
                    }
                },
                xAxis: {
                    type: 'time',
                    axisLine: { lineStyle: { color: colors.axisLineColor } },
                    axisLabel: {
                        color: colors.axisLabelColor,
                        fontFamily: thaiFont
                    }
                },
                yAxis: {
                    type: 'value', name: '¬µg/m¬≥',
                    axisLine: { lineStyle: { color: colors.axisLineColor } },
                    splitLine: { lineStyle: { color: colors.splitLineColor } },
                    axisLabel: {
                        color: colors.axisLabelColor,
                        fontFamily: thaiFont
                    },
                    nameTextStyle: { fontFamily: thaiFont }
                },
                series: [
                    {
                        name: 'PM2.5',
                        type: 'line',
                        showSymbol: false,
                        smooth: true,
                        data: [],
                        itemStyle: { color: colors.pm25Color },
                        lineStyle: { color: colors.pm25Color }
                    },
                    {
                        name: 'PM10',
                        type: 'line',
                        showSymbol: false,
                        smooth: true,
                        data: [],
                        itemStyle: { color: colors.pm10Color },
                        lineStyle: { color: colors.pm10Color }
                    }
                ]
            };
        }

        function initChart() {
            const chartEl = document.getElementById('chart');
            if (chart) {
                chart.dispose();
            }
            chart = echarts.init(chartEl);
            chart.setOption(createBaseChartOption());
        }

        // Initialize chart
        initChart();

        window.addEventListener('resize', () => chart.resize());

        // ------------------------------
        // Data loading & UI wiring
        // ------------------------------
        async function fetchJSON(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
                return await res.json();
            } catch (err) {
                console.warn('API endpoint ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô, ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö', url, err.message);
                return null;
            }
        }

        async function loadDevices() {
            const data = await fetchJSON(API.devices);
            const devices = Array.isArray(data) && data.length ? data : DEMO_DEVICES;

            // Update device count and dropdown
            document.getElementById('device-count').textContent = devices.length.toString();
            const select = document.getElementById('device-select');
            select.innerHTML = devices.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

            if (devices.length) {
                document.getElementById('selected-device').textContent = devices[0].name;
            }
            if (devices[0]?.updated_at) {
                document.getElementById('last-update').textContent = new Date(devices[0].updated_at).toLocaleString();
            }

            // Build GeoJSON features
            const features = devices.map(d => ({
                type: 'Feature',
                properties: { id: d.id, name: d.name, pm25: d.pm25 ?? 0, pm10: d.pm10 ?? 0 },
                geometry: { type: 'Point', coordinates: [d.lon, d.lat] }
            }));

            const collection = { type: 'FeatureCollection', features };
            const src = map.getSource(devicesSourceId);
            if (src) src.setData(collection);

            // Fit bounds
            if (features.length) {
                const b = new maplibregl.LngLatBounds();
                features.forEach(f => b.extend(f.geometry.coordinates));
                try { map.fitBounds(b, { padding: 40, duration: 800 }); } catch { }
            }

            return devices;
        }

        async function loadTimeseries(deviceId, rangeValue) {
            // Parse range value
            const hours = rangeValue.endsWith('h') ? parseInt(rangeValue) : (rangeValue === '7d' ? 24 * 7 : 24);
            const url = API.timeseries(deviceId, rangeValue);
            const data = await fetchJSON(url);
            const ts = (Array.isArray(data) && data.length) ? data : mockTimeseries(deviceId, hours);
            return ts;
        }

        async function refreshChart() {
            const deviceId = document.getElementById('device-select').value;
            const rangeValue = document.getElementById('time-range').value;

            if (!deviceId) return;

            const ts = await loadTimeseries(deviceId, rangeValue);
            const series25 = ts.map(p => [p.timestamp, p.pm25]);
            const series10 = ts.map(p => [p.timestamp, p.pm10]);

            const colors = getChartThemeColors();

            chart.setOption({
                title: {
                    text: `PM2.5 / PM10 ‚Äì ${deviceId}`,
                    left: 12,
                    top: 6,
                    textStyle: {
                        color: colors.textColor,
                        fontSize: 12,
                        fontWeight: 500
                    }
                },
                series: [
                    { data: series25 },
                    { data: series10 }
                ]
            });

            if (ts.length) {
                document.getElementById('last-update').textContent = new Date(ts[ts.length - 1].timestamp).toLocaleString();
            }
        }

        async function initializeApp() {
            const devices = await loadDevices();
            if (devices.length) {
                document.getElementById('device-select').value = devices[0].id;
            }
            await refreshChart();
        }

        // Theme switching functionality
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeToggle(savedTheme);
        }

        function updateThemeToggle(theme) {
            const darkIcon = document.querySelector('.dark-icon');
            const lightIcon = document.querySelector('.light-icon');

            if (theme === 'light') {
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden');
            } else {
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeToggle(newTheme);

            // Reinitialize chart with new theme
            initChart();
            refreshChart();
        }

        // Authentication popup functionality
        function openAuthPopup() {
            document.getElementById('auth-popup').classList.remove('hidden');
        }

        function closeAuthPopup() {
            document.getElementById('auth-popup').classList.add('hidden');
        }

        function updateAuthDisplay(isAuthenticated, userInfo = null) {
            const authStatus = document.getElementById('auth-status');
            const authButton = document.getElementById('auth-button');
            const authIcon = document.getElementById('auth-icon');
            const authText = document.getElementById('auth-text');
            const logoutBtn = document.getElementById('btn-logout');

            if (isAuthenticated) {
                authStatus.textContent = userInfo || '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
                authIcon.textContent = '‚úì';
                authText.textContent = '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
                authButton.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                authStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                authIcon.textContent = 'üîí';
                authText.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                authButton.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        // Initialize theme on page load
        initTheme();

        // UI events
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        document.getElementById('auth-button').addEventListener('click', openAuthPopup);
        document.getElementById('auth-popup-close').addEventListener('click', closeAuthPopup);
        document.getElementById('auth-popup').addEventListener('click', (e) => {
            if (e.target.id === 'auth-popup') closeAuthPopup();
        });
        document.getElementById('device-select').addEventListener('change', () => refreshChart());
        document.getElementById('time-range').addEventListener('change', () => refreshChart());
        document.getElementById('btn-refresh').addEventListener('click', () => refreshChart());

    </script>
</body>

</html>